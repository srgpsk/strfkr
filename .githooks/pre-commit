#!/bin/sh
# Pre-commit hook: linting and formatting only

set -e

echo "üîç Running pre-commit checks..."

# Check if this is an initial commit
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=4b825dc642cb6eb9a060e54bf8d69288fbee4904
fi

# Check if there are any staged changes
if ! git diff --cached --quiet; then
    echo "üìù Found staged changes, proceeding with checks..."
    
    # Generate SQLC code first (since it's not in git)
    echo "üîÑ Generating SQLC code..."
    if ! sqlc generate -f sqlc.spider.yaml; then
        echo "‚ùå Failed to generate SQLC code"
        exit 1
    fi
    
    # Get list of staged Go files
    STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM $against | grep '\.go$' || true)

    if [ -n "$STAGED_GO_FILES" ]; then
        echo "üìù Formatting Go files..."
        
        # Format Go files
        echo "$STAGED_GO_FILES" | xargs gofmt -w -s
        echo "$STAGED_GO_FILES" | xargs goimports -w
        
        # Add formatted files back to staging
        echo "$STAGED_GO_FILES" | xargs git add
        
        echo "üî¨ Running go vet..."
        go vet ./...
        
        echo "üßπ Running go mod tidy..."
        go mod tidy
        git add go.mod go.sum
        
        echo "üîç Running golangci-lint..."
        golangci-lint run --fix
        
        # Add any files that golangci-lint might have fixed
        echo "$STAGED_GO_FILES" | xargs git add
    fi

    # Check for other file types
    STAGED_OTHER_FILES=$(git diff --cached --name-only --diff-filter=ACM $against | grep -v '\.go$' || true)

    if [ -n "$STAGED_OTHER_FILES" ]; then
        echo "üìÑ Checking and formatting other files..."
        
        # Auto-fix YAML files with yamlfmt (Go-based)
        YAML_FILES=$(echo "$STAGED_OTHER_FILES" | grep '\.ya\?ml$' || true)
        if [ -n "$YAML_FILES" ]; then
            if command -v yamlfmt >/dev/null 2>&1; then
                echo "üé® Auto-fixing YAML files with yamlfmt..."
                echo "$YAML_FILES" | xargs yamlfmt
                # Re-stage the fixed files
                echo "$YAML_FILES" | xargs git add
                echo "‚úÖ YAML files formatted"
            else
                echo "‚ö†Ô∏è  yamlfmt not found, skipping YAML formatting"
            fi
        fi
        
        # Validate JSON files using Go standard library
        JSON_FILES=$(echo "$STAGED_OTHER_FILES" | grep '\.json$' || true)
        if [ -n "$JSON_FILES" ]; then
            echo "üìã Validating JSON files with Go..."
            for file in $JSON_FILES; do
                # Use Go to validate JSON
                if ! go run -c 'package main
import ("encoding/json"; "io"; "os")
func main() {
    var v interface{}
    if err := json.NewDecoder(os.Stdin).Decode(&v); err != nil {
        os.Exit(1)
    }
}' < "$file" 2>/dev/null; then
                    echo "‚ùå Invalid JSON syntax in: $file"
                    exit 1
                fi
            done
            echo "‚úÖ JSON files validated with Go"
        fi
    fi

    echo "‚úÖ Pre-commit checks passed!"
else
    echo "‚ö†Ô∏è  No staged changes found. Skipping pre-commit checks."
    # Exit with success - let Git handle the "no changes" message
    exit 0
fi