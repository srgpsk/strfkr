#!/bin/sh
# Pre-push hook: run full test suite

set -e

echo "ğŸ§ª Running full test suite before push..."

# Run all tests with race detection
echo "ğŸƒ Running tests with race detection..."
go test -race ./...

# Run coverage calculation with exclusions
echo "ğŸ“Š Running tests with coverage..."
bash scripts/coverage.sh

# Check coverage threshold for tested packages only
COVERAGE=$(bash scripts/coverage.sh)
THRESHOLD=60  # Lowered to 60% for tested packages only

if [ "${COVERAGE%.*}" -lt $THRESHOLD ]; then
    echo "âŒ Test coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
    echo "ğŸ’¡ Focus on testing business logic in config/, logger/, sitemap/, and service/"
    exit 1
fi

echo "âœ… All tests passed! Coverage: $COVERAGE%"